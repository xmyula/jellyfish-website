<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>åˆæˆå¤§æ°´æ¯</title>
  <style>

   #gameWrapper {
  width: 600px;
  margin: 0 auto;
  transform: scale(0.8);
  transform-origin: top center;
}

canvas {
  background: #e0f7fa;
  display: block;
  margin: auto;
}

    

  #rankingBox {
    width: 400px;
    margin: 10px auto;
    padding: 10px;
    background: #e0f2f1;
    border-radius: 10px;
    font-family: Arial;
  }

  #rankingBox h3 {
    margin: 5px 0;
    text-align: center;
    color: #004d40;
  }

  #rankingList {
    padding-left: 20px;
  }

  #rankingList li {
    margin: 4px 0;
  }

  #rankingBox {
  position: fixed;
  right: 10px;
  top: 80px;
  width: 180px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  font-family: Arial, sans-serif;
}

#rankingBox h3 {
  margin: 0 0 8px 0;
  font-size: 16px;
  text-align: center;
}

#rankingList {
  padding-left: 20px;
  margin: 0;
  font-size: 14px;
}

#rankingList li.me {
  font-weight: bold;
  color: #d32f2f;
}

#helpBox {
  position: fixed;
  left: 10px;
  top: 80px;
  width: 180px;
  background: rgba(255,255,255,0.9);
  border-radius: 12px;
  padding: 10px;
  font-family: Arial, sans-serif;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

#helpBox h3 {
  margin: 0 0 8px 0;
  font-size: 16px;
  text-align: center;
}

#helpBox ul {
  padding-left: 18px;
  font-size: 13px;
  margin: 0;
}


  </style>
</head>

<body>
  
<div id="authOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:flex; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:15px; text-align:center;">
    <h3>ğŸª¼ ç™»å…¥/è¨»å†Šä»¥é–‹å§‹éŠæˆ²</h3>
    <input type="text" id="authUser" placeholder="å¸³è™Ÿ" style="display:block; margin:10px auto; padding:8px;">
    <input type="password" id="authPass" placeholder="å¯†ç¢¼" style="display:block; margin:10px auto; padding:8px;">
    <button onclick="login()" style="padding:8px 20px; background:#00796b; color:white; border:none; border-radius:5px; cursor:pointer;">é€²å…¥éŠæˆ²</button>
    <p id="loginMsg" style="color:red; font-size:12px;"></p>
  </div>
</div>
  
<h2 style="text-align:center;">åˆæˆå¤§æ°´æ¯ ğŸª¼</h2>

<div id="helpBox">
  <h3>ğŸ® æ“ä½œèªªæ˜</h3>
  <ul>
    <li>éµç›¤æ“ä½œï¼š</li>
    <li>â¬…â¡å·¦å³éµæ§åˆ¶æ°´æ¯ç§»å‹•</li>
    <li>ç©ºç™½éµ è½ä¸‹</li>
    <li>æ»‘é¼ æ“ä½œï¼š</li>
    <li>ğŸ–±æ»‘é¼ æ§åˆ¶æ°´æ¯ç§»å‹•</li>
    <li>ğŸ–±æ»‘é¼ å·¦éµ è½ä¸‹</li>
    <li>ğŸª¼ç›¸åŒæ°´æ¯æœƒåˆæˆ</li>
    <li>ğŸš¨æ°´æ¯è¶…éä¸Šæ–¹3ç§’å³çµæŸ</li>
  </ul>
</div>

<div id="gameWrapper">
  <canvas id="game" width="600" height="620" tabindex="1"></canvas>
</div>

<div id="rankingBox">
  <div id="nextBox">
  <h3>ğŸª¼ ä¸‹ä¸€å€‹</h3>
  <img id="nextImg">
</div>

  <h3>ğŸ† æ’è¡Œæ¦œ TOP 10</h3>
  <ol id="rankingList"></ol>
  <button onclick="location.href='ranking.html'" style="margin-top:8px; width:100%; cursor:pointer; background:#00796b; color:white; border:none; border-radius:4px; padding:5px;">
  æŸ¥çœ‹å®Œæ•´æ’è¡Œ
</button>
</div>
<script>
// --- 1. å…¨åŸŸè®Šæ•¸å®šç¾© (åªåœ¨é€™è£¡å®£å‘Šä¸€æ¬¡) ---
let currentUser = null;
let gameEnded = false; 
let score = 0; 
let overTopStartTime = null; 
let nextLevel = Math.floor(Math.random() * 5) + 1;

const DANGER_TIME = 3000;
const SPACING = 4; 
const RANKING_API = "https://script.google.com/macros/s/AKfycbzWt6d0fNs-cnpm-qd1BXWXrBFAD-ju1Rjgfu-VQAxlTttWSQzE8IosFCwnkm5X5-FRkw/exec";

// --- 2. åœ–ç‰‡è³‡æºç®¡ç† ---
const jellyfishImages = {
  1: "https://cdn-icons-png.flaticon.com/128/2104/2104958.png",
  2: "https://cdn-icons-png.flaticon.com/128/2104/2104975.png",
  3: "https://cdn-icons-png.flaticon.com/128/2104/2104982.png",
  4: "https://cdn-icons-png.flaticon.com/128/2104/2104988.png",
  5: "https://cdn-icons-png.flaticon.com/128/2105/2105001.png",
  6: "https://cdn-icons-png.flaticon.com/128/2105/2105008.png",
  7: "https://cdn-icons-png.flaticon.com/128/2105/2105021.png",
  8: "https://cdn-icons-png.flaticon.com/128/2105/2105034.png",
  9: "https://cdn-icons-png.flaticon.com/128/3564/3564858.png",
  10: "https://cdn-icons-png.flaticon.com/128/3564/3564871.png",
  11: "https://cdn-icons-png.flaticon.com/128/3564/3564893.png"
};

const imageCache = {};
for (let i = 1; i <= 11; i++) {
  const img = new Image();
  img.src = jellyfishImages[i];
  imageCache[i] = img;
}

// --- 3. åˆå§‹åŒ–èˆ‡ Canvas è¨­å®š ---
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const groundY = canvas.height - 20;
const jellyfishes = [];

window.onload = () => {
  showRanking();
  updateNextPreview();
  gameLoop();
};

// --- 4. éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---
class Jellyfish {
  constructor(x, y, level) {
    this.x = x; this.y = y; this.level = level;
    this.radius = 20 + Math.pow(level, 1.4) * 4;
    this.vx = 0; this.vy = 0;
    this.isDropping = false; this.isSleeping = false;
  }
  update() {
    if (!this.isSleeping) this.vy = Math.min(this.vy + 1.5, 15);
    this.x += this.vx; this.y += this.vy;
    if (this.y + this.radius >= groundY) { this.y = groundY - this.radius; this.vy = 0; this.isSleeping = true; }
    if (this.isSleeping) { this.vx *= 0.6; this.vy *= 0.6; }
  }
  draw() {
    const img = imageCache[this.level];
    if (img) ctx.drawImage(img, this.x - this.radius, this.y - this.radius, this.radius * 2, this.radius * 2);
  }
}

function createNewJellyfish() {
  const j = new Jellyfish(canvas.width / 2, 50, nextLevel);
  nextLevel = Math.floor(Math.random() * 5) + 1;
  updateNextPreview();
  j.isSleeping = true;
  return j;
}

let currentJellyfish = createNewJellyfish();

function gameLoop() {
  if (gameEnded) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // ç•«åœ°æ¿èˆ‡åˆ†æ•¸
  ctx.fillStyle = "#006064"; ctx.fillRect(0, groundY, canvas.width, 5);
  ctx.fillStyle = "#004d40"; ctx.font = "20px Arial"; ctx.fillText(`Score: ${score}`, 10, 30);

  if (currentJellyfish) {
    currentJellyfish.update();
    currentJellyfish.draw();
    if (currentJellyfish.isDropping) {
      let landingY = groundY - currentJellyfish.radius;
      for (const j of jellyfishes) {
        if (Math.abs(currentJellyfish.x - j.x) < currentJellyfish.radius + j.radius) {
          let pos = j.y - j.radius - currentJellyfish.radius - SPACING;
          if (pos < landingY) landingY = pos;
        }
      }
      if (currentJellyfish.y >= landingY) {
        currentJellyfish.y = landingY;
        currentJellyfish.isDropping = false;
        currentJellyfish.isSleeping = true;
        jellyfishes.push(currentJellyfish);
        currentJellyfish = createNewJellyfish();
      }
    }
  }

  for (let i = 0; i < jellyfishes.length; i++) {
    for (let j = i + 1; j < jellyfishes.length; j++) {
      const a = jellyfishes[i], b = jellyfishes[j];
      const dx = a.x - b.x, dy = a.y - b.y;
      if (Math.sqrt(dx*dx + dy*dy) < a.radius + b.radius - 1) {
        if (a.level === b.level) { mergeJellyfish(i, j); break; }
        else { resolveCollision(a, b); }
      }
    }
    jellyfishes[i].update();
    if (jellyfishes[i].x < jellyfishes[i].radius) jellyfishes[i].x = jellyfishes[i].radius;
    if (jellyfishes[i].x > canvas.width - jellyfishes[i].radius) jellyfishes[i].x = canvas.width - jellyfishes[i].radius;
    jellyfishes[i].draw();
  }

  checkGameOver();
  requestAnimationFrame(gameLoop);
}

// --- 5. åŠŸèƒ½å‡½æ•¸ ---
function mergeJellyfish(i, j) {
  const j1 = jellyfishes[i], j2 = jellyfishes[j];
  const scoreTable = { 1:1, 2:3, 3:6, 4:10, 5:15, 6:21, 7:28, 8:36, 9:45, 10:55, 11:66 };
  score += scoreTable[j1.level];
  const x = (j1.x + j2.x)/2, y = (j1.y + j2.y)/2, nL = j1.level + 1;
  jellyfishes.splice(Math.max(i,j), 1);
  jellyfishes.splice(Math.min(i,j), 1);
  if (nL <= 11) jellyfishes.push(new Jellyfish(x, y, nL));
}

function resolveCollision(a, b) {
  const dx = b.x - a.x, dy = b.y - a.y;
  const dist = Math.sqrt(dx*dx + dy*dy);
  const overlap = (a.radius + b.radius + SPACING) - dist;
  if (overlap > 0 && dist > 0) {
    const nx = dx/dist, ny = dy/dist;
    a.x -= nx * overlap / 2; a.y -= ny * overlap / 2;
    b.x += nx * overlap / 2; b.y += ny * overlap / 2;
    a.isSleeping = b.isSleeping = false;
  }
}

function checkGameOver() {
  if (jellyfishes.some(j => j.y - j.radius <= 50)) {
    if (!overTopStartTime) overTopStartTime = Date.now();
    let elapsed = Date.now() - overTopStartTime;
    ctx.strokeStyle = "red"; ctx.lineWidth = 5; ctx.strokeRect(0,0,canvas.width,canvas.height);
    if (elapsed > DANGER_TIME) endGame();
  } else { overTopStartTime = null; }
}

function updateNextPreview() {
  const img = document.getElementById("nextImg");
  if (img) img.src = jellyfishImages[nextLevel];
}

// --- 6. äº’å‹•èˆ‡ API å‡½æ•¸ ---
function login() {
  const user = document.getElementById("authUser").value;
  const pass = document.getElementById("authPass").value;
  const msg = document.getElementById("loginMsg");
  if(!user || !pass) return alert("è«‹è¼¸å…¥å¸³å¯†");
  msg.innerText = "é©—è­‰ä¸­...";
  fetch(`${RANKING_API}?action=login&user=${encodeURIComponent(user)}&pass=${encodeURIComponent(pass)}`)
    .then(res => res.json()).then(data => {
      if(data.success) {
        currentUser = user; document.getElementById("authOverlay").style.display = "none";
        showRanking();
      } else { msg.innerText = data.msg; }
    }).catch(() => msg.innerText = "é€£ç·šå¤±æ•—");
}

function showRanking() {
  fetch(RANKING_API + "?action=get").then(res => res.json()).then(data => {
    const list = document.getElementById("rankingList");
    if (!list || !Array.isArray(data)) return;
    list.innerHTML = "";
    data.slice(0, 10).forEach(item => {
      const li = document.createElement("li");
      li.textContent = `${item[0]} - ${item[1]}åˆ†`;
      if (currentUser && item[0] === currentUser) { li.style.color="red"; li.style.fontWeight="bold"; }
      list.appendChild(li);
    });
  });
}

function endGame() {
  if (gameEnded) return;
  gameEnded = true;
  alert(`éŠæˆ²çµæŸï¼å¾—åˆ†: ${score}`);
  if (currentUser) {
    fetch(`${RANKING_API}?action=save&user=${encodeURIComponent(currentUser)}&score=${score}`)
      .then(() => showRanking());
  }
}

// æ§åˆ¶ç›£è½
canvas.addEventListener("mousemove", e => {
  if (currentJellyfish && !currentJellyfish.isDropping) {
    currentJellyfish.x = e.offsetX;
    if (currentJellyfish.x < currentJellyfish.radius) currentJellyfish.x = currentJellyfish.radius;
    if (currentJellyfish.x > canvas.width - currentJellyfish.radius) currentJellyfish.x = canvas.width - currentJellyfish.radius;
  }
});
canvas.addEventListener("mouseup", () => {
  if (currentJellyfish) { currentJellyfish.isDropping = true; currentJellyfish.isSleeping = false; }
});
document.addEventListener("keydown", e => {
  if (!currentJellyfish || currentJellyfish.isDropping) return;
  if (e.key === "ArrowLeft") currentJellyfish.x = Math.max(currentJellyfish.radius, currentJellyfish.x - 25);
  if (e.key === "ArrowRight") currentJellyfish.x = Math.min(canvas.width - currentJellyfish.radius, currentJellyfish.x + 25);
  if (e.key === " ") { currentJellyfish.isDropping = true; currentJellyfish.isSleeping = false; }
});
</script>
</body>
</html>
